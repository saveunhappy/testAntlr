<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business DSL Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/monokai.css" rel="stylesheet">
    <style>
        .CodeMirror {
            height: 400px;
            border: 1px solid #ddd;
        }
        .sidebar {
            height: 100vh;
            overflow-y: auto;
        }
        .script-item {
            cursor: pointer;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .script-item:hover {
            background-color: #f8f9fa;
        }
        .script-item.active {
            background-color: #007bff;
            color: white;
        }
        .output-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 200px;
            font-family: monospace;
        }
        .function-list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 sidebar bg-light">
                <div class="p-3">
                    <h5>脚本管理</h5>
                    <div class="mb-3">
                        <input type="text" id="newScriptName" class="form-control" placeholder="新脚本名称">
                        <button class="btn btn-primary btn-sm mt-2" onclick="createNewScript()">新建脚本</button>
                    </div>

                    <h6>脚本列表</h6>
                    <div id="scriptList"></div>

                    <hr>

                    <h6>内置函数</h6>
                    <div class="function-list">
                        <div class="small">
                            <strong>数学函数:</strong><br>
                            abs(x), max(x,y), min(x,y), round(x)<br><br>

                            <strong>字符串函数:</strong><br>
                            length(str), substring(str,start,end), toUpperCase(str), toLowerCase(str)<br><br>

                            <strong>业务函数:</strong><br>
                            calculateDiscount(amount,rate), validateOrder(amount), getCustomerLevel(totalSpent)<br><br>

                            <strong>日志函数:</strong><br>
                            log(message), logError(message)
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主编辑区 -->
            <div class="col-md-6">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="currentScriptName">DSL编辑器</h4>
                        <div>
                            <button class="btn btn-success" onclick="saveScript()">保存</button>
                            <button class="btn btn-info" onclick="validateScript()">验证</button>
                            <button class="btn btn-warning" onclick="runScript()">运行</button>
                        </div>
                    </div>

                    <textarea id="editor"></textarea>

                    <div class="mt-3">
                        <h6>执行上下文</h6>
                        <textarea id="contextEditor" class="form-control" rows="3" placeholder='{"amount": 100, "customerLevel": "VIP"}'></textarea>
                    </div>
                </div>
            </div>

            <!-- 输出区 -->
            <div class="col-md-3">
                <div class="p-3">
                    <h6>执行结果</h6>
                    <div id="output" class="output-panel"></div>

                    <hr>

                    <h6>示例脚本</h6>
                    <div class="small">
                        <strong>订单折扣计算:</strong><br>
                        <pre style="font-size: 11px;">
var amount = 1000;
var discount = calculateDiscount(amount, 0.1);
log("订单金额: " + amount);
log("折扣金额: " + discount);
return amount - discount;</pre>

                        <strong>客户等级判断:</strong><br>
                        <pre style="font-size: 11px;">
var totalSpent = 8000;
var level = getCustomerLevel(totalSpent);
if (level == "VIP") {
    log("VIP客户享受特殊优惠");
} else {
    log("普通客户");
}
return level;</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.js"></script>
    <script>
        let editor;
        let currentScript = null;

        // 初始化编辑器
        document.addEventListener('DOMContentLoaded', function() {
            editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                mode: 'javascript',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true
            });

            loadScriptList();
        });

        // 加载脚本列表
        async function loadScriptList() {
            try {
                const response = await fetch('/api/dsl/scripts');
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                if (data.success) {
                    const scriptList = document.getElementById('scriptList');
                    scriptList.innerHTML = '';

                    Object.keys(data.data).forEach(scriptName => {
                        const div = document.createElement('div');
                        div.className = 'script-item';
                        div.textContent = scriptName;
                        div.onclick = () => loadScript(scriptName);
                        scriptList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('加载脚本列表失败:', error);
                alert(error.message);  // 添加用户可见的错误提示
                document.getElementById('scriptList').innerHTML = '<div class="text-danger">加载失败，请刷新重试</div>';
            }
        }

        // 加载脚本
        async function loadScript(scriptName) {
            try {
                const response = await fetch(`/api/dsl/scripts/${scriptName}`);
                if (!response.ok) {
                    throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                if (data.success) {
                    editor.setValue(data.data);
                    currentScript = scriptName;
                    document.getElementById('currentScriptName').textContent = scriptName;

                    // 更新选中状态
                    document.querySelectorAll('.script-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    event.target.classList.add('active');
                }
            } catch (error) {
                console.error('加载脚本失败:', error);
                alert(error.message);  // 添加用户可见的错误提示
                editor.setValue('// 加载脚本失败\n// ' + error.message);
            }
        }

        // 创建新脚本
        function createNewScript() {
            const scriptName = document.getElementById('newScriptName').value.trim();
            if (!scriptName) {
                alert('请输入脚本名称');
                return;
            }

            editor.setValue('');
            currentScript = scriptName;
            document.getElementById('currentScriptName').textContent = scriptName;
            document.getElementById('newScriptName').value = '';
        }

        // 保存脚本
        async function saveScript() {
            if (!currentScript) {
                alert('请先创建或选择脚本');
                return;
            }

            try {
                const content = editor.getValue();
                const response = await fetch(`/api/dsl/scripts/${currentScript}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                if (!response.ok) {  // 新增状态检查
                    throw new Error(`保存失败: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.success) {
                    alert('保存成功');
                    loadScriptList();
                } else {
                    alert('保存失败: ' + data.error);
                }
            } catch (error) {
                console.error('保存失败:', error);
                alert(error.message);  // 改进错误提示
            }
        }

        // 验证脚本
        async function validateScript() {
            try {
                const content = editor.getValue();
                const response = await fetch('/api/dsl/scripts/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();
                if (data.success) {
                    if (data.valid) {
                        alert('语法验证通过');
                    } else {
                        alert('语法验证失败');
                    }
                } else {
                    alert('验证失败: ' + data.error);
                }
            } catch (error) {
                console.error('验证失败:', error);
                alert('验证失败');
            }
        }

        // 运行脚本
        async function runScript() {
            if (!currentScript) {
                alert('请先创建或选择脚本');
                return;
            }

            try {
                const contextText = document.getElementById('contextEditor').value;
                let context = {};

                if (contextText.trim()) {
                    try {
                        context = JSON.parse(contextText);
                    } catch (e) {
                        alert('执行上下文JSON格式错误');
                        return;
                    }
                }

                const response = await fetch(`/api/dsl/scripts/${currentScript}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(context)
                });

                const data = await response.json();
                const output = document.getElementById('output');

                if (data.success) {
                    output.innerHTML = `<div class="text-success">执行成功:</div><pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                } else {
                    output.innerHTML = `<div class="text-danger">执行失败:</div><pre>${data.error}</pre>`;
                }
            } catch (error) {
                console.error('执行失败:', error);
                document.getElementById('output').innerHTML = `<div class="text-danger">执行失败:</div><pre>${error.message}</pre>`;
            }
        }
    </script>
</body>
</html>
